name: Release DMG

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Manual version (e.g., 1.0.0)"
        required: false

permissions:
  contents: write

jobs:
  release:
    name: build-and-release
    runs-on: macos-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG="v${VERSION}"
          else
            VERSION="0.0.${{ github.run_number }}"
            TAG="v${VERSION}"
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Build app (unsigned)
        run: |
          xcodebuild \
            -project "dhavnii.xcodeproj" \
            -scheme "openwispher" \
            -configuration Release \
            -destination "platform=macOS" \
            -derivedDataPath "build/DerivedData" \
            clean build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Create DMG and metadata
        id: pkg
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          APP_PATH=$(find "build/DerivedData/Build/Products/Release" -maxdepth 1 -name "*.app" -type d | head -n 1)
          if [[ -z "$APP_PATH" ]]; then
            echo "No .app found in build output" >&2
            exit 1
          fi

          rm -rf dist/stage
          mkdir -p dist/stage
          cp -R "$APP_PATH" dist/stage/
          # Standard drag-install UX in Finder
          ln -sfn /Applications dist/stage/Applications
          if [[ ! -L "dist/stage/Applications" ]]; then
            echo "Failed to create Applications link" >&2
            exit 1
          fi

          VERSIONED_DMG="Openwispher-${VERSION}.dmg"
          LATEST_DMG="Openwispher-latest.dmg"

          hdiutil create \
            -volname "Openwispher" \
            -srcfolder "dist/stage" \
            -ov \
            -format UDZO \
            "dist/${VERSIONED_DMG}"
          hdiutil verify "dist/${VERSIONED_DMG}"

          cp "dist/${VERSIONED_DMG}" "dist/${LATEST_DMG}"

          SHA256=$(shasum -a 256 "dist/${VERSIONED_DMG}" | awk '{print $1}')
          echo "${SHA256}  ${VERSIONED_DMG}" > "dist/${VERSIONED_DMG}.sha256"

          cat > dist/latest.json <<JSON
          {
            "version": "${VERSION}",
            "dmg_url": "https://github.com/${GITHUB_REPOSITORY}/releases/latest/download/${LATEST_DMG}",
            "notes_url": "https://github.com/${GITHUB_REPOSITORY}/releases/tag/${TAG}",
            "sha256": "${SHA256}",
            "published_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          JSON

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Openwispher v${{ steps.version.outputs.version }}
          generate_release_notes: true
          files: |
            dist/*.dmg
            dist/*.sha256
            dist/latest.json
